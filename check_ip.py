import json
import os

from virustotal3 import core

API_KEY = os.environ['VT_API']


class CheckIp:
    def __init__(self, ip, pid):
        self.pid = pid
        self.ip = ip
        self.harmless_points = 0
        self.malicious_points = 0
        self.suspicious = 0
        self.vt = core.IP(API_KEY)

    def check(self):
        result = self.vt.info_ip(ip=self.ip, timeout=500)
        last_analysis_stats = result['data']['attributes']['last_analysis_stats']
        self.harmless_points = last_analysis_stats['harmless']
        self.malicious_points = last_analysis_stats['malicious']
        with open(f'report\\connection\\{self.pid}', "a") as convert_file:
            convert_file.write(json.dumps({'Harmless': self.harmless_points, 'Malicious': self.malicious_points}))
            convert_file.close()
