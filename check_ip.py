import json
import os

from virustotal3 import core

from const import MALICIOUS, IP

API_KEY = os.environ['VT_API']


class CheckIp:
    def __init__(self, ip, pid, name):
        self.pid = pid
        self.name = name
        self.ip = ip
        self.harmless_points = 0
        self.malicious_points = 0
        self.suspicious = 0
        self.vt = core.IP(API_KEY)

    def check(self):
        result = self.vt.info_ip(ip=self.ip, timeout=500)
        last_analysis_stats = result['data']['attributes']['last_analysis_stats']
        self.harmless_points = last_analysis_stats['harmless']
        self.malicious_points = last_analysis_stats['malicious']
        actual_malicious_points = self.malicious_points
        print(actual_malicious_points)
        need_rewrite = False
        try:
            with open(f'report\\connection\\{self.name}', "r") as convert_file:
                dictionary = json.load(convert_file)
                malicious_points = dictionary[MALICIOUS]
                need_rewrite = malicious_points < actual_malicious_points
                convert_file.close()
            if need_rewrite:
                with open(f'report\\connection\\{self.name}', "w") as convert_file:
                    convert_file.write(json.dumps({IP: self.ip, MALICIOUS: self.malicious_points}))
                    convert_file.close()
        except:
            with open(f'report\\connection\\{self.name}', "w") as convert_file:
                convert_file.write(json.dumps({IP: self.ip, MALICIOUS: self.malicious_points}))
                convert_file.close()
