import json
from os import walk
from pathlib import Path

from const import PID, EXE_DIFF_POINT, EXE_SECTION_NUMBER, IP, MALICIOUS, PROC_NAME, FILENAME, WX_SECTION, PACK, \
    HAS_VALID_CERT


class GeneralReport:

    def __init__(self):
        self.filename = 'report\\general\\general_report'
        self.connection_report = 'report\\connection'
        self.info_report = 'report\\info'
        self.diff_report = 'report\\diff'

    def _handle_info_report(self):
        processes = []
        filenames = next(walk(self.info_report), (None, None, []))[2]
        for filename in filenames:
            with open(f'{self.info_report}\\{filename}') as json_data:
                d = json.load(json_data)
                processes.append(d)
                json_data.close()
        return processes

    def _handle_diff_report(self, processes):
        processes_with_diff = []
        for process in processes:
            filename = f'{self.diff_report}\\{process[PID]}'
            diff_report = Path(filename)
            if diff_report.exists():
                with open(filename) as json_data:
                    d = json.load(json_data)
                    process[EXE_DIFF_POINT] = d[EXE_DIFF_POINT]
                    process[EXE_SECTION_NUMBER] = d[EXE_SECTION_NUMBER]
                    json_data.close()
            else:
                process[EXE_DIFF_POINT] = None
                process[EXE_SECTION_NUMBER] = None
            processes_with_diff.append(process)
        return processes_with_diff

    def _handle_connection_report(self, processes):
        process_with_connection = []
        for process in processes:
            filename = f'{self.connection_report}\\{process[PROC_NAME]}'
            diff_report = Path(filename)
            if diff_report.exists():
                with open(filename) as json_data:
                    d = json.load(json_data)
                    process[IP] = d[IP]
                    process[MALICIOUS] = d[MALICIOUS]
                    json_data.close()
            else:
                process[IP] = None
                process[MALICIOUS] = None
            process_with_connection.append(process)
        return process_with_connection

    def generate_report(self):
        processes = self._handle_info_report()
        processes = self._handle_diff_report(processes)
        processes = self._handle_connection_report(processes)
        self._print_as_table(processes)
        self._write_to_general_report(processes)

    def _print_as_table(self, processes):
        for process in processes:
            print(process)

    def _write_to_general_report(self, processes):
        with open(self.filename, "w") as report:
            for process in processes:
                report.write(f'PID: {process[PID]}\n')
                report.write(f'PROCESS NAME: {process[PROC_NAME]}\n')
                report.write(f'PROCESS EXE FILE: {process[FILENAME]}\n')
                report.write(f'NUMBER OF WX SECTIONS: {process[WX_SECTION]}\n')
                report.write(f'IS PACKED: {process[PACK]}\n')
                report.write(f'HAS VALID CERT: {process[HAS_VALID_CERT]}\n')
                if process[EXE_DIFF_POINT] is None:
                    report.write(f'FAILED TO COMPARE EXE WITH DUMP\n')
                else:
                    report.write(
                        f'PERCENT OF MISMATCHED SECTORS EXE AND DUMP : {process[EXE_DIFF_POINT] / process[EXE_SECTION_NUMBER] * 100}%\n')
                if process[IP] is None:
                    report.write(f'HAS NOT GOT CONNECTIONS\n')
                else:
                    report.write(f'THE MOST DANGEROUS CONNECTION WAS IDENTIFIED WITH THE ADDRESS: {process[IP]} ')
                    report.write(f'HAS MALICIOUS: {process[MALICIOUS]}\n')
                report.write('=======================================================================================')
                report.write('\n\n')
